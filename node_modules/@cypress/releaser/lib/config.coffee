fs        = require("fs-extra")
path      = require("path")
chalk     = require("chalk")
Promise   = require("bluebird")
cwd       = require("./utils/cwd")
git       = require("./git")
questions = require("./questions")

fs           = Promise.promisifyAll(fs)
RELEASE_PATH = cwd(".release.json")
DEFAULTS     = {
  commitMessage: "release %s"
  tagAnnotation: "release %s"
  github: {
    release: false
    releaseName: "release %s"
  }
}

module.exports = {
  create: ->
    fs.writeJsonAsync(RELEASE_PATH, DEFAULTS, {spaces: 2})

  commit: ->
    git.commit(RELEASE_PATH, "created #{path.basename(RELEASE_PATH)}")

  ensure: ->
    ## verify we have a cwd(".release.json")
    fs
    .statAsync(RELEASE_PATH)
    .catch =>
      questions.askToCreateConfig(RELEASE_PATH)
      .then (bool) =>
        if bool
          @create()
          .then(@commit)
        else
          console.log("")
          console.log(chalk.red("Cannot continue without the release configuration."))
          console.log("")
          process.exit(0)
}